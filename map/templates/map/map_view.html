{% load static %}
<!DOCTYPE html>
<html lang="fa">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ù‚Ø´Ù‡ Ù‡ÙˆØ´Ù…Ù†Ø¯</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js" defer></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css"/>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js" defer></script>
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
</head>
<body class="map-page">

<div class="search-container">
    <input type="text" id="searchBox" placeholder="Ù†Ø§Ù… Ù…Ú©Ø§Ù† Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯">
    <div class="suggestions" id="suggestions"></div>
    <button id="searchBtn">ğŸ”</button>
</div>

<div id="map"></div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        console.log("âœ… ØµÙØ­Ù‡ Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ Ø´Ø¯!");

        let map = L.map('map').setView([35.6892, 51.3890], 12); // ØªÙ‡Ø±Ø§Ù†

        let streetLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: 'Â© OpenStreetMap contributors'
        });

        let satelliteLayer = L.tileLayer('https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri'
        });

        let topoLayer = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenTopoMap contributors'
        });

        streetLayer.addTo(map);

        let baseMaps = {
            "Ù†Ù‚Ø´Ù‡ Ø®ÛŒØ§Ø¨Ø§Ù†ÛŒ": streetLayer,
            "Ù†Ù‚Ø´Ù‡ Ù…Ø§Ù‡ÙˆØ§Ø±Ù‡â€ŒØ§ÛŒ": satelliteLayer,
            "Ù†Ù‚Ø´Ù‡ ØªÙˆÙ¾ÙˆÚ¯Ø±Ø§ÙÛŒ": topoLayer
        };
        L.control.layers(baseMaps).addTo(map);

        L.control.scale({
            position: 'bottomleft',
            metric: true,
            imperial: false
        }).addTo(map);

        let searchInput = document.getElementById("searchBox");
        let searchButton = document.getElementById("searchBtn");
        let suggestionsBox = document.getElementById("suggestions");

        function getJSON(url, callback) {
            let xhr = new XMLHttpRequest();
            xhr.open("GET", url, true);
            xhr.onreadystatechange = function () {
                if (xhr.readyState === 4 && xhr.status === 200) {
                    callback(JSON.parse(xhr.responseText));
                }
            };
            xhr.send();
        }

        searchInput.addEventListener("input", function () {
            let query = searchInput.value.trim();
            if (query.length < 2) {
                suggestionsBox.style.display = "none";
                return;
            }

            let url = "https://nominatim.openstreetmap.org/search?format=json&q=" + encodeURIComponent(query);
            getJSON(url, function (data) {
                suggestionsBox.innerHTML = "";
                if (data.length > 0) {
                    suggestionsBox.style.display = "block";
                    data.forEach(place => {
                        let suggestion = document.createElement("div");
                        suggestion.innerText = place.display_name;
                        suggestion.onclick = function () {
                            searchInput.value = place.display_name;
                            suggestionsBox.style.display = "none";
                            let lat = parseFloat(place.lat);
                            let lon = parseFloat(place.lon);
                            if (!isNaN(lat) && !isNaN(lon)) {
                                map.setView([lat, lon], 14);
                                L.marker([lat, lon]).addTo(map)
                                    .bindPopup(place.display_name)
                                    .openPopup();
                            }
                        };
                        suggestionsBox.appendChild(suggestion);
                    });
                } else {
                    suggestionsBox.style.display = "none";
                }
            });
        });

        searchButton.addEventListener("click", function () {
            let query = searchInput.value.trim();
            if (query === "") {
                alert("Ù„Ø·ÙØ§ Ù†Ø§Ù… ÛŒÚ© Ù…Ú©Ø§Ù† Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.");
                return;
            }

            let url = "https://nominatim.openstreetmap.org/search?format=json&q=" + encodeURIComponent(query);
            getJSON(url, function (data) {
                if (data.length > 0) {
                    let lat = parseFloat(data[0].lat);
                    let lon = parseFloat(data[0].lon);
                    if (!isNaN(lat) && !isNaN(lon)) {
                        map.setView([lat, lon], 14);
                        L.marker([lat, lon]).addTo(map)
                            .bindPopup(data[0].display_name)
                            .openPopup();
                    }
                } else {
                    alert("Ù…Ú©Ø§Ù† Ù…ÙˆØ±Ø¯Ù†Ø¸Ø± ÛŒØ§ÙØª Ù†Ø´Ø¯.");
                }
            });
        });

    });
</script>
<div class="footer-container">
    <p> Â© ØªÙ…Ø§Ù… Ù…Ø§Ù„Ú©ÛŒØª Ø­Ù‚ÙˆÙ‚ÛŒ Ø§ÛŒÙ† ÙˆØ¨ Ø³Ø§ÛŒØª Ù…ØªØ¹Ù„Ù‚ Ø¨Ù‡ Ø¯Ø§Ù†Ø´Ø¬Ùˆ Ù…ÛŒâ€ŒØ¨Ø§Ø´Ø¯</p>
    <a href="{% url 'home:home' %}" class="logout-btn">Ø®Ø±ÙˆØ¬ Ø§Ø² Ù†Ù‚Ø´Ù‡</a>
</div>
</body>
</html>